<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT技术情报系统 - 多工作流管理器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
        }

        .make-info {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .make-info h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }

        .info-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .info-value {
            font-weight: 600;
            color: #495057;
            font-family: 'Courier New', monospace;
        }

        .api-config {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 30px;
        }

        .api-config h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .api-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }

        .controls {
            padding: 20px 30px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
            border-bottom: 1px solid #e9ecef;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .workflow-section {
            padding: 30px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #495057;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .workflow-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .workflow-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .card-header {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-bottom: 1px solid #dee2e6;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #495057;
            margin-bottom: 5px;
        }

        .card-subtitle {
            color: #6c757d;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .status-unknown {
            background: #e2e3e5;
            color: #383d41;
        }

        .card-body {
            padding: 20px;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            font-size: 0.85rem;
        }

        .config-label {
            color: #6c757d;
        }

        .config-value {
            font-weight: 600;
            color: #495057;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
        }

        .scenario-id-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            margin-top: 5px;
        }

        .card-actions {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .card-actions .btn {
            flex: 1;
            justify-content: center;
            font-size: 0.8rem;
            padding: 8px 12px;
            min-width: 80px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success { background: #28a745; }
        .toast-error { background: #dc3545; }
        .toast-info { background: #17a2b8; }

        .add-workflow {
            border: 2px dashed #ced4da;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .add-workflow:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .add-workflow-content {
            text-align: center;
            color: #6c757d;
        }

        .add-workflow-content i {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .workflow-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                padding: 15px;
            }
            
            .card-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面头部 -->
        <div class="header">
            <h1>🎯 ICT技术情报系统多工作流管理器</h1>
            <p>统一管理你的所有Make.com工作流</p>
        </div>

        <!-- Make环境信息 -->
        <div class="make-info">
            <h3>🔧 Make环境信息</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Make服务器</div>
                    <div class="info-value">us2.make.com</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Team ID</div>
                    <div class="info-value">972028</div>
                </div>
                <div class="info-item">
                    <div class="info-label">已配置工作流</div>
                    <div class="info-value" id="workflowCount">0</div>
                </div>
                <div class="info-item">
                    <div class="info-label">API连接状态</div>
                    <div class="info-value" id="connectionStatus">未配置</div>
                </div>
            </div>
        </div>

        <!-- API配置区域 -->
        <div class="api-config">
            <h4>🔑 Make API配置</h4>
            <p style="color: #856404; margin-bottom: 15px; font-size: 0.9rem;">
                配置API Token后可以直接控制工作流。获取方式：Make.com → 个人设置 → API → 生成新Token
            </p>
            <input type="password" id="apiToken" class="api-input" placeholder="输入你的Make API Token" />
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <button class="btn btn-primary" onclick="saveApiToken()">💾 保存Token</button>
                <button class="btn btn-info" onclick="testConnection()">🔍 测试连接</button>
                <button class="btn btn-warning" onclick="loadAllScenarios()">📥 自动加载工作流</button>
            </div>
        </div>

        <!-- 全局控制区 -->
        <div class="controls">
            <button class="btn btn-success" onclick="runAllWorkflows()">
                ▶️ 运行所有工作流
            </button>
            <button class="btn btn-warning" onclick="pauseAllWorkflows()">
                ⏸️ 暂停所有工作流
            </button>
            <button class="btn btn-info" onclick="refreshAllStatus()">
                🔄 刷新所有状态
            </button>
            <button class="btn btn-secondary" onclick="exportAllConfigs()">
                📤 导出所有配置
            </button>
            <a href="https://us2.make.com/972028/scenarios" target="_blank" class="btn btn-primary">
                🔗 打开Make控制台
            </a>
        </div>

        <!-- 工作流管理区域 -->
        <div class="workflow-section">
            <div class="section-title">📋 工作流管理</div>
            <div class="workflow-grid" id="workflowGrid">
                <!-- 工作流卡片将在这里动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // Make API配置
        let makeConfig = {
            baseUrl: 'https://us2.make.com',
            teamId: '972028',
            apiToken: localStorage.getItem('makeApiToken') || ''
        };

        // 工作流数据存储
        let workflows = JSON.parse(localStorage.getItem('workflows')) || {
            'WF1': {
                id: 'WF1',
                name: '学术论文监控流',
                description: '监控arXiv、Google Scholar等学术论文',
                scenarioId: '',
                category: '数据采集层',
                status: 'unknown',
                lastRun: null
            },
            'WF2': {
                id: 'WF2', 
                name: '专利申请追踪流',
                description: '追踪USPTO、EPO等专利申请',
                scenarioId: '',
                category: '数据采集层',
                status: 'unknown',
                lastRun: null
            },
            'WF3': {
                id: 'WF3',
                name: '开源项目监测流', 
                description: '监测GitHub、GitLab等开源项目',
                scenarioId: '',
                category: '数据采集层',
                status: 'unknown',
                lastRun: null
            },
            'WF4': {
                id: 'WF4',
                name: '产业新闻获取流',
                description: '获取TechCrunch等产业新闻',
                scenarioId: '',
                category: '数据采集层', 
                status: 'unknown',
                lastRun: null
            },
            'WF5': {
                id: 'WF5',
                name: '产业动态捕获流',
                description: '捕获会议、SEC文件等产业动态',
                scenarioId: '',
                category: '数据采集层',
                status: 'unknown',
                lastRun: null
            },
            'WF6': {
                id: 'WF6',
                name: '竞争对手收集流',
                description: '收集竞争对手相关情报',
                scenarioId: '',
                category: '数据采集层',
                status: 'unknown',
                lastRun: null
            },
            'WF7': {
                id: 'WF7',
                name: '技术信号识别流',
                description: '识别技术突破信号',
                scenarioId: '2196216', // 你提供的现有ID
                category: '信号识别层',
                status: 'unknown',
                lastRun: null
            },
            'WF8': {
                id: 'WF8',
                name: '证据验证处理流',
                description: '验证情报证据质量',
                scenarioId: '',
                category: '信号识别层',
                status: 'unknown', 
                lastRun: null
            },
            'WF9': {
                id: 'WF9',
                name: '商业价值分析流',
                description: '分析技术商业价值',
                scenarioId: '',
                category: '深度分析层',
                status: 'unknown',
                lastRun: null
            },
            'WF10': {
                id: 'WF10',
                name: '竞争情报分析流',
                description: '分析竞争态势',
                scenarioId: '',
                category: '深度分析层',
                status: 'unknown',
                lastRun: null
            },
            'WF11': {
                id: 'WF11',
                name: '技术深度分析流',
                description: '深度分析技术可行性',
                scenarioId: '',
                category: '深度分析层',
                status: 'unknown',
                lastRun: null
            },
            'WF12': {
                id: 'WF12',
                name: '情报整合决策流',
                description: '整合情报生成决策建议',
                scenarioId: '',
                category: '决策支撑层',
                status: 'unknown',
                lastRun: null
            },
            'WF13': {
                id: 'WF13',
                name: '报告生成输出流',
                description: '生成并分发情报报告',
                scenarioId: '',
                category: '决策支撑层',
                status: 'unknown',
                lastRun: null
            }
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // 初始化页面
        function initializePage() {
            loadApiToken();
            renderWorkflowGrid();
            updateWorkflowCount();
            
            if (makeConfig.apiToken) {
                testConnection();
            }
        }

        // 加载保存的API Token
        function loadApiToken() {
            const savedToken = localStorage.getItem('makeApiToken');
            if (savedToken) {
                makeConfig.apiToken = savedToken;
                document.getElementById('apiToken').value = savedToken;
            }
        }

        // 保存API Token
        function saveApiToken() {
            const token = document.getElementById('apiToken').value.trim();
            if (!token) {
                showToast('请输入API Token', 'error');
                return;
            }
            
            makeConfig.apiToken = token;
            localStorage.setItem('makeApiToken', token);
            showToast('API Token已保存', 'success');
            
            setTimeout(testConnection, 1000);
        }

        // 测试API连接
        async function testConnection() {
            if (!makeConfig.apiToken) {
                showToast('请先配置API Token', 'error');
                return;
            }

            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = '测试中...';
            statusElement.style.color = '#ffc107';

            try {
                // 使用Make API v2测试连接
                const response = await fetch(`${makeConfig.baseUrl}/api/v2/scenarios?teamId=${makeConfig.teamId}&limit=1`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${makeConfig.apiToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    statusElement.textContent = '✅ 连接成功';
                    statusElement.style.color = '#28a745';
                    showToast('Make API连接成功', 'success');
                } else if (response.status === 401) {
                    statusElement.textContent = '❌ Token无效';
                    statusElement.style.color = '#dc3545';
                    showToast('API Token无效，请检查', 'error');
                } else if (response.status === 403) {
                    statusElement.textContent = '❌ 权限不足';
                    statusElement.style.color = '#dc3545';
                    showToast('API Token权限不足', 'error');
                } else {
                    statusElement.textContent = '❌ 连接失败';
                    statusElement.style.color = '#dc3545';
                    showToast(`连接失败: ${response.status}`, 'error');
                }
            } catch (error) {
                statusElement.textContent = '❌ 网络错误';
                statusElement.style.color = '#dc3545';
                showToast('网络连接错误，可能是CORS限制', 'error');
                console.error('连接测试失败:', error);
            }
        }

        // 自动加载所有工作流
        async function loadAllScenarios() {
            if (!makeConfig.apiToken) {
                showToast('请先配置API Token', 'error');
                return;
            }

            showToast('正在加载工作流...', 'info');

            try {
                const response = await fetch(`${makeConfig.baseUrl}/api/v2/scenarios?teamId=${makeConfig.teamId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${makeConfig.apiToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const scenarios = data.scenarios || data;
                    
                    showToast(`发现 ${scenarios.length} 个工作流`, 'success');
                    
                    // 为每个发现的scenario创建或更新工作流
                    scenarios.forEach((scenario, index) => {
                        const workflowId = `WF${index + 1}`;
                        if (!workflows[workflowId]) {
                            workflows[workflowId] = {
                                id: workflowId,
                                name: scenario.name || `工作流 ${index + 1}`,
                                description: scenario.description || '自动发现的工作流',
                                scenarioId: scenario.id,
                                category: '自动发现',
                                status: scenario.isActive ? 'active' : 'inactive',
                                lastRun: scenario.lastRun || null
                            };
                        } else {
                            workflows[workflowId].scenarioId = scenario.id;
                            workflows[workflowId].status = scenario.isActive ? 'active' : 'inactive';
                        }
                    });
                    
                    saveWorkflows();
                    renderWorkflowGrid();
                    updateWorkflowCount();
                } else {
                    throw new Error(`加载失败: ${response.status}`);
                }
            } catch (error) {
                showToast(`加载失败: ${error.message}`, 'error');
                console.error('加载工作流失败:', error);
            }
        }

        // 渲染工作流网格
        function renderWorkflowGrid() {
            const grid = document.getElementById('workflowGrid');
            grid.innerHTML = '';

            // 按类别分组
            const categories = ['数据采集层', '信号识别层', '深度分析层', '决策支撑层', '自动发现'];
            
            categories.forEach(category => {
                const categoryWorkflows = Object.values(workflows).filter(wf => wf.category === category);
                
                if (categoryWorkflows.length > 0) {
                    // 添加类别标题
                    const categoryTitle = document.createElement('div');
                    categoryTitle.style.gridColumn = '1 / -1';
                    categoryTitle.style.fontSize = '1.1rem';
                    categoryTitle.style.fontWeight = '600';
                    categoryTitle.style.color = '#495057';
                    categoryTitle.style.margin = '20px 0 10px 0';
                    categoryTitle.style.paddingBottom = '8px';
                    categoryTitle.style.borderBottom = '2px solid #e9ecef';
                    categoryTitle.textContent = `📊 ${category}`;
                    grid.appendChild(categoryTitle);
                    
                    // 添加该类别的工作流卡片
                    categoryWorkflows.forEach(workflow => {
                        const card = createWorkflowCard(workflow);
                        grid.appendChild(card);
                    });
                }
            });

            // 添加新增工作流卡片
            const addCard = createAddWorkflowCard();
            grid.appendChild(addCard);
        }

        // 创建工作流卡片
        function createWorkflowCard(workflow) {
            const card = document.createElement('div');
            card.className = 'workflow-card';
            card.id = `card-${workflow.id}`;

            const statusClass = getStatusClass(workflow.status);
            const statusText = getStatusText(workflow.status);

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${workflow.id}: ${workflow.name}</div>
                    <div class="card-subtitle">${workflow.description}</div>
                    <div class="status-indicator ${statusClass}">
                        ${statusText}
                    </div>
                </div>
                <div class="card-body">
                    <div class="config-item">
                        <span class="config-label">Scenario ID:</span>
                        <span class="config-value">${workflow.scenarioId || '未配置'}</span>
                    </div>
                    <input type="text" class="scenario-id-input" 
                           placeholder="输入Scenario ID" 
                           value="${workflow.scenarioId || ''}"
                           onchange="updateScenarioId('${workflow.id}', this.value)">
                    
                    <div class="config-item">
                        <span class="config-label">最后运行:</span>
                        <span class="config-value">${workflow.lastRun || '未知'}</span>
                    </div>
                    <div class="config-item">
                        <span class="config-label">类别:</span>
                        <span class="config-value">${workflow.category}</span>
                    </div>

                    <div class="card-actions">
                        <button class="btn btn-success" onclick="runWorkflow('${workflow.id}')">
                            ▶️ 运行
                        </button>
                        <button class="btn btn-warning" onclick="pauseWorkflow('${workflow.id}')">
                            ⏸️ 暂停
                        </button>
                        <button class="btn btn-info" onclick="getWorkflowStatus('${workflow.id}')">
                            🔄 状态
                        </button>
                        <button class="btn btn-primary" onclick="openMakeEditor('${workflow.id}')">
                            🔗 编辑
                        </button>
                        <button class="btn btn-secondary" onclick="viewLogs('${workflow.id}')">
                            📋 日志
                        </button>
                        <button class="btn btn-danger" onclick="deleteWorkflow('${workflow.id}')">
                            🗑️ 删除
                        </button>
                    </div>
                </div>
            `;

            return card;
        }

        // 创建添加工作流卡片
        function createAddWorkflowCard() {
            const card = document.createElement('div');
            card.className = 'add-workflow';
            card.onclick = addNewWorkflow;

            card.innerHTML = `
                <div class="add-workflow-content">
                    <div style="font-size: 3rem; margin-bottom: 10px;">➕</div>
                    <div style="font-size: 1.1rem; font-weight: 600;">添加新工作流</div>
                    <div style="font-size: 0.9rem; margin-top: 5px;">点击创建新的工作流配置</div>
                </div>
            `;

            return card;
        }

        // 获取状态样式类
        function getStatusClass(status) {
            switch (status) {
                case 'active': return 'status-active';
                case 'inactive': return 'status-inactive';
                case 'running': return 'status-active';
                default: return 'status-unknown';
            }
        }

        // 获取状态文本
        function getStatusText(status) {
            switch (status) {
                case 'active': return '✅ 活跃';
                case 'inactive': return '⏸️ 暂停';
                case 'running': return '🔄 运行中';
                default: return '❓ 未知';
            }
        }

        // 更新Scenario ID
        function updateScenarioId(workflowId, scenarioId) {
            workflows[workflowId].scenarioId = scenarioId.trim();
            saveWorkflows();
            showToast(`${workflowId} Scenario ID已更新`, 'info');
        }

        // 运行单个工作流
        async function runWorkflow(workflowId) {
            const workflow = workflows[workflowId];
            if (!workflow.scenarioId) {
                showToast('请先配置Scenario ID', 'error');
                return;
            }

            if (!makeConfig.apiToken) {
                showToast('请先配置API Token', 'error');
                return;
            }

            showToast(`正在运行 ${workflowId}...`, 'info');

            try {
                const response = await fetch(`${makeConfig.baseUrl}/api/v2/scenarios/${workflow.scenarioId}/run`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${makeConfig.apiToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    showToast(`${workflowId} 运行成功`, 'success');
                    workflow.status = 'running';
                    workflow.lastRun = new Date().toLocaleString();
                    saveWorkflows();
                    renderWorkflowGrid();
                } else {
                    throw new Error(`运行失败: ${response.status}`);
                }
            } catch (error) {
                showToast(`${workflowId} 运行失败: ${error.message}`, 'error');
            }
        }

            // 暂停单个工作流
        async function pauseWorkflow(workflowId) {
            const workflow = workflows[workflowId];
            if (!workflow.scenarioId) {
                showToast('请先配置Scenario ID', 'error');
                return;
            }

            if (!makeConfig.apiToken) {
                showToast('请先配置API Token', 'error');
                return;
            }

            if (!confirm(`确定要暂停 ${workflowId} 吗？`)) return;

            try {
                const response = await fetch(`${makeConfig.baseUrl}/api/v2/scenarios/${workflow.scenarioId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Token ${makeConfig.apiToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        scheduling: {
                            type: 'indefinitely'
                        }
                    })
                });

                if (response.ok) {
                    showToast(`${workflowId} 已暂停`, 'success');
                    workflow.status = 'inactive';
                    saveWorkflows();
                    renderWorkflowGrid();
                } else {
                    throw new Error(`暂停失败: ${response.status}`);
                }
            } catch (error) {
                showToast(`${workflowId} 暂停失败: ${error.message}`, 'error');
            }
        }

        // 获取单个工作流状态
        async function getWorkflowStatus(workflowId) {
            const workflow = workflows[workflowId];
            if (!workflow.scenarioId) {
                showToast('请先配置Scenario ID', 'error');
                return;
            }

            if (!makeConfig.apiToken) {
                showToast('请先配置API Token', 'error');
                return;
            }

            try {
                const response = await fetch(`${makeConfig.baseUrl}/api/v2/scenarios/${workflow.scenarioId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Token ${makeConfig.apiToken}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    workflow.status = data.scheduling && data.scheduling.type !== 'indefinitely' ? 'active' : 'inactive';
                    if (data.lastRun) {
                        workflow.lastRun = new Date(data.lastRun).toLocaleString();
                    }
                    saveWorkflows();
                    renderWorkflowGrid();
                    showToast(`${workflowId} 状态已更新`, 'success');
                } else {
                    throw new Error(`获取状态失败: ${response.status}`);
                }
            } catch (error) {
                showToast(`${workflowId} 状态获取失败: ${error.message}`, 'error');
            }
        }

        // 打开Make编辑器
        function openMakeEditor(workflowId) {
            const workflow = workflows[workflowId];
            if (!workflow.scenarioId) {
                showToast('请先配置Scenario ID', 'error');
                return;
            }

            const url = `${makeConfig.baseUrl}/${makeConfig.teamId}/scenarios/${workflow.scenarioId}/edit`;
            window.open(url, '_blank');
        }

        // 查看运行日志
        function viewLogs(workflowId) {
            const workflow = workflows[workflowId];
            if (!workflow.scenarioId) {
                showToast('请先配置Scenario ID', 'error');
                return;
            }

            const url = `${makeConfig.baseUrl}/${makeConfig.teamId}/scenarios/${workflow.scenarioId}/runs`;
            window.open(url, '_blank');
        }

        // 删除工作流
        function deleteWorkflow(workflowId) {
            if (!confirm(`确定要删除 ${workflowId} 吗？这将从本地配置中移除该工作流。`)) return;

            delete workflows[workflowId];
            saveWorkflows();
            renderWorkflowGrid();
            updateWorkflowCount();
            showToast(`${workflowId} 已删除`, 'info');
        }

        // 添加新工作流
        function addNewWorkflow() {
            const name = prompt('请输入工作流名称:');
            if (!name) return;

            const description = prompt('请输入工作流描述:') || '';
            const scenarioId = prompt('请输入Scenario ID (可选):') || '';

            // 生成新的工作流ID
            const existingIds = Object.keys(workflows).map(id => parseInt(id.replace('WF', ''))).filter(n => !isNaN(n));
            const newId = `WF${Math.max(...existingIds, 0) + 1}`;

            workflows[newId] = {
                id: newId,
                name: name,
                description: description,
                scenarioId: scenarioId,
                category: '自定义',
                status: 'unknown',
                lastRun: null
            };

            saveWorkflows();
            renderWorkflowGrid();
            updateWorkflowCount();
            showToast(`${newId} 已添加`, 'success');
        }

        // 运行所有工作流
        async function runAllWorkflows() {
            if (!confirm('确定要运行所有配置了Scenario ID的工作流吗？')) return;

            const configuredWorkflows = Object.values(workflows).filter(wf => wf.scenarioId);
            if (configuredWorkflows.length === 0) {
                showToast('没有配置Scenario ID的工作流', 'error');
                return;
            }

            showToast(`正在运行 ${configuredWorkflows.length} 个工作流...`, 'info');

            for (const workflow of configuredWorkflows) {
                await runWorkflow(workflow.id);
                // 间隔1秒避免API限制
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            showToast('所有工作流运行完成', 'success');
        }

        // 暂停所有工作流
        async function pauseAllWorkflows() {
            if (!confirm('确定要暂停所有工作流吗？')) return;

            const configuredWorkflows = Object.values(workflows).filter(wf => wf.scenarioId);
            if (configuredWorkflows.length === 0) {
                showToast('没有配置Scenario ID的工作流', 'error');
                return;
            }

            showToast(`正在暂停 ${configuredWorkflows.length} 个工作流...`, 'info');

            for (const workflow of configuredWorkflows) {
                await pauseWorkflow(workflow.id);
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            showToast('所有工作流已暂停', 'success');
        }

        // 刷新所有状态
        async function refreshAllStatus() {
            const configuredWorkflows = Object.values(workflows).filter(wf => wf.scenarioId);
            if (configuredWorkflows.length === 0) {
                showToast('没有配置Scenario ID的工作流', 'error');
                return;
            }

            showToast(`正在刷新 ${configuredWorkflows.length} 个工作流状态...`, 'info');

            for (const workflow of configuredWorkflows) {
                await getWorkflowStatus(workflow.id);
                await new Promise(resolve => setTimeout(resolve, 300));
            }

            showToast('所有状态已刷新', 'success');
        }

        // 导出所有配置
        function exportAllConfigs() {
            const exportData = {
                makeConfig: makeConfig,
                workflows: workflows,
                exportTime: new Date().toISOString(),
                version: '1.0.0'
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `ict-workflows-config-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('配置已导出', 'success');
        }

        // 保存工作流配置
        function saveWorkflows() {
            try {
                localStorage.setItem('workflows', JSON.stringify(workflows));
            } catch (error) {
                console.error('保存工作流配置失败:', error);
                showToast('保存配置失败', 'error');
            }
        }

        // 更新工作流数量显示
        function updateWorkflowCount() {
            const count = Object.keys(workflows).length;
            document.getElementById('workflowCount').textContent = count;
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // 键盘快捷键支持
        document.addEventListener('keydown', function(e) {
            // Ctrl+R 刷新所有状态
            if (e.ctrlKey && e.key === 'r') {
                e.preventDefault();
                refreshAllStatus();
            }
            // Ctrl+S 保存配置
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveWorkflows();
                showToast('配置已保存', 'success');
            }
            // Ctrl+E 导出配置
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportAllConfigs();
            }
        });

        // 定时自动保存
        setInterval(saveWorkflows, 30000); // 每30秒自动保存一次

        // 页面卸载前保存
        window.addEventListener('beforeunload', function() {
            saveWorkflows();
        });
    </script>
</body>
</html>
