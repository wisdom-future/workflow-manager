<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICT技术情报系统 - 多工作流管理器</title>
    <!-- 保持原有的CSS样式不变 -->
    <style>
        /* 原有CSS保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .cors-warning {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 30px;
            color: #721c24;
        }

        .cors-warning h4 {
            margin-bottom: 10px;
        }

        .solution-tabs {
            display: flex;
            gap: 10px;
            margin: 20px 30px 0 30px;
        }

        .tab-button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px 8px 0 0;
            background: #e9ecef;
            cursor: pointer;
            font-weight: 600;
        }

        .tab-button.active {
            background: #007bff;
            color: white;
        }

        .tab-content {
            display: none;
            background: #f8f9fa;
            padding: 20px;
            margin: 0 30px 20px 30px;
            border-radius: 0 8px 8px 8px;
        }

        .tab-content.active {
            display: block;
        }

        .webhook-section {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 30px;
        }

        .webhook-item {
            margin-bottom: 15px;
        }

        .webhook-label {
            font-weight: 600;
            color: #0c5460;
            margin-bottom: 5px;
        }

        .webhook-input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        /* 保持其他原有样式 */
        .make-info, .api-config, .controls, .workflow-section, 
        .workflow-grid, .workflow-card, .btn, .toast {
            /* 原有样式保持不变 */
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 页面头部 -->
        <div class="header">
            <h1>🎯 ICT技术情报系统多工作流管理器</h1>
            <p>统一管理你的所有Make.com工作流</p>
        </div>

        <!-- CORS问题说明 -->
        <div class="cors-warning">
            <h4>⚠️ 网络连接错误说明</h4>
            <p>由于浏览器的CORS安全限制，无法直接调用Make API。请选择以下解决方案：</p>
        </div>

        <!-- 解决方案选项卡 -->
        <div class="solution-tabs">
            <button class="tab-button active" onclick="showTab('webhook')">Webhook方案</button>
            <button class="tab-button" onclick="showTab('browser')">浏览器方案</button>
            <button class="tab-button" onclick="showTab('manual')">手动方案</button>
        </div>

        <!-- Webhook方案 -->
        <div id="webhook-tab" class="tab-content active">
            <h4>🔗 Webhook触发方案（推荐）</h4>
            <p>通过Make的Webhook功能来触发工作流，无需API Token，更加稳定可靠。</p>
            
            <div style="margin-top: 15px;">
                <h5>设置步骤：</h5>
                <ol style="margin-left: 20px; line-height: 1.6;">
                    <li>在Make中为每个Scenario添加Webhook触发器</li>
                    <li>复制Webhook URL到下面的配置中</li>
                    <li>点击"触发"按钮即可运行工作流</li>
                </ol>
            </div>
        </div>

        <!-- 浏览器方案 -->
        <div id="browser-tab" class="tab-content">
            <h4>🌐 浏览器扩展方案</h4>
            <p>安装CORS浏览器扩展来绕过限制：</p>
            
            <div style="margin-top: 15px;">
                <h5>Chrome用户：</h5>
                <ol style="margin-left: 20px; line-height: 1.6;">
                    <li>安装 "CORS Unblock" 或 "CORS Toggle" 扩展</li>
                    <li>启用扩展</li>
                    <li>刷新此页面</li>
                    <li>重新测试API连接</li>
                </ol>
                
                <h5 style="margin-top: 15px;">Firefox用户：</h5>
                <ol style="margin-left: 20px; line-height: 1.6;">
                    <li>安装 "CORS Everywhere" 扩展</li>
                    <li>启用扩展</li>
                    <li>刷新此页面</li>
                </ol>
            </div>
        </div>

        <!-- 手动方案 -->
        <div id="manual-tab" class="tab-content">
            <h4>👤 手动管理方案</h4>
            <p>直接在Make.com控制台管理工作流：</p>
            
            <div style="margin-top: 15px;">
                <a href="https://us2.make.com/972028/scenarios" target="_blank" class="btn btn-primary">
                    🔗 打开Make控制台
                </a>
                <p style="margin-top: 10px; font-size: 0.9rem; color: #6c757d;">
                    在Make控制台中可以直接运行、暂停、查看日志等操作
                </p>
            </div>
        </div>

        <!-- Webhook配置区域 -->
        <div class="webhook-section">
            <h4>🔗 Webhook配置</h4>
            <p style="margin-bottom: 15px; color: #0c5460;">为每个工作流配置Webhook URL，然后就可以直接触发运行：</p>
            
            <div id="webhookConfigs">
                <!-- Webhook配置项将在这里动态生成 -->
            </div>
            
            <div style="margin-top: 15px;">
                <button class="btn btn-success" onclick="triggerAllWebhooks()">🚀 触发所有工作流</button>
                <button class="btn btn-info" onclick="saveWebhookConfigs()">💾 保存Webhook配置</button>
                <button class="btn btn-secondary" onclick="exportWebhookConfigs()">📤 导出配置</button>
            </div>
        </div>

        <!-- 原有的工作流管理区域 -->
        <div class="workflow-section">
            <div class="section-title">📋 工作流管理（Webhook模式）</div>
            <div class="workflow-grid" id="workflowGrid">
                <!-- 工作流卡片将在这里动态生成 -->
            </div>
        </div>
    </div>

    <script>
        // 工作流配置
        let workflows = JSON.parse(localStorage.getItem('workflows')) || {
            'WF1': { id: 'WF1', name: '学术论文监控流', description: '监控arXiv、Google Scholar等学术论文', webhookUrl: '', category: '数据采集层' },
            'WF2': { id: 'WF2', name: '专利申请追踪流', description: '追踪USPTO、EPO等专利申请', webhookUrl: '', category: '数据采集层' },
            'WF3': { id: 'WF3', name: '开源项目监测流', description: '监测GitHub、GitLab等开源项目', webhookUrl: '', category: '数据采集层' },
            'WF4': { id: 'WF4', name: '产业新闻获取流', description: '获取TechCrunch等产业新闻', webhookUrl: '', category: '数据采集层' },
            'WF5': { id: 'WF5', name: '产业动态捕获流', description: '捕获会议、SEC文件等产业动态', webhookUrl: '', category: '数据采集层' },
            'WF6': { id: 'WF6', name: '竞争对手收集流', description: '收集竞争对手相关情报', webhookUrl: '', category: '数据采集层' },
            'WF7': { id: 'WF7', name: '技术信号识别流', description: '识别技术突破信号', webhookUrl: '', category: '信号识别层' },
            'WF8': { id: 'WF8', name: '证据验证处理流', description: '验证情报证据质量', webhookUrl: '', category: '信号识别层' },
            'WF9': { id: 'WF9', name: '商业价值分析流', description: '分析技术商业价值', webhookUrl: '', category: '深度分析层' },
            'WF10': { id: 'WF10', name: '竞争情报分析流', description: '分析竞争态势', webhookUrl: '', category: '深度分析层' },
            'WF11': { id: 'WF11', name: '技术深度分析流', description: '深度分析技术可行性', webhookUrl: '', category: '深度分析层' },
            'WF12': { id: 'WF12', name: '情报整合决策流', description: '整合情报生成决策建议', webhookUrl: '', category: '决策支撑层' },
            'WF13': { id: 'WF13', name: '报告生成输出流', description: '生成并分发情报报告', webhookUrl: '', category: '决策支撑层' }
        };

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // 初始化页面
        function initializePage() {
            renderWebhookConfigs();
            renderWorkflowGrid();
        }

        // 显示选项卡
        function showTab(tabName) {
            // 隐藏所有选项卡
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            // 显示选中的选项卡
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        // 渲染Webhook配置
        function renderWebhookConfigs() {
            const container = document.getElementById('webhookConfigs');
            container.innerHTML = '';

            Object.values(workflows).forEach(workflow => {
                const item = document.createElement('div');
                item.className = 'webhook-item';
                item.innerHTML = `
                    <div class="webhook-label">${workflow.id}: ${workflow.name}</div>
                    <div style="display: flex; gap: 10px;">
                        <input type="url" class="webhook-input" 
                               placeholder="输入Webhook URL" 
                               value="${workflow.webhookUrl || ''}"
                               onchange="updateWebhookUrl('${workflow.id}', this.value)">
                        <button class="btn btn-success" onclick="triggerWebhook('${workflow.id}')" 
                                ${!workflow.webhookUrl ? 'disabled' : ''}>
                            ▶️ 触发
                        </button>
                    </div>
                `;
                container.appendChild(item);
            });
        }

        // 更新Webhook URL
        function updateWebhookUrl(workflowId, url) {
            workflows[workflowId].webhookUrl = url.trim();
            saveWorkflows();
            renderWebhookConfigs(); // 重新渲染以更新按钮状态
            showToast(`${workflowId} Webhook URL已更新`, 'info');
        }

        // 触发单个Webhook
        async function triggerWebhook(workflowId) {
            const workflow = workflows[workflowId];
            if (!workflow.webhookUrl) {
                showToast('请先配置Webhook URL', 'error');
                return;
            }

            showToast(`正在触发 ${workflowId}...`, 'info');

            try {
                const response = await fetch(workflow.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trigger_source: 'webhook_manager',
                        workflow_id: workflowId,
                        timestamp: new Date().toISOString(),
                        user: 'Jason'
                    })
                });

                if (response.ok) {
                    showToast(`${workflowId} 触发成功！`, 'success');
                    workflow.lastRun = new Date().toLocaleString();
                    workflow.status = 'running';
                    saveWorkflows();
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showToast(`${workflowId} 触发失败: ${error.message}`, 'error');
                console.error('Webhook触发失败:', error);
            }
        }

        // 触发所有Webhook
        async function triggerAllWebhooks() {
            const configuredWorkflows = Object.values(workflows).filter(wf => wf.webhookUrl);
            if (configuredWorkflows.length === 0) {
                showToast('没有配置Webhook URL的工作流', 'error');
                return;
            }

            if (!confirm(`确定要触发所有 ${configuredWorkflows.length} 个工作流吗？`)) return;

            showToast(`正在触发 ${configuredWorkflows.length} 个工作流...`, 'info');

            for (const workflow of configuredWorkflows) {
                await triggerWebhook(workflow.id);
                // 间隔1秒避免过快触发
                await new Promise(resolve => setTimeout(resolve, 1000));
            }

            showToast('所有工作流触发完成！', 'success');
        }

        // 保存Webhook配置
        function saveWebhookConfigs() {
            saveWorkflows();
            showToast('Webhook配置已保存', 'success');
        }

        // 导出Webhook配置
        function exportWebhookConfigs() {
            const exportData = {
                workflows: workflows,
                exportTime: new Date().toISOString(),
                type: 'webhook_config'
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `webhook-configs-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('Webhook配置已导出', 'success');
        }

        // 渲染工作流网格（简化版）
        function renderWorkflowGrid() {
            const grid = document.getElementById('workflowGrid');
            grid.innerHTML = '';

            const categories = ['数据采集层', '信号识别层', '深度分析层', '决策支撑层'];

            categories.forEach(category => {
                const categoryWorkflows = Object.values(workflows).filter(wf => wf.category === category);

                if (categoryWorkflows.length > 0) {
                    // 添加类别标题
                    const categoryTitle = document.createElement('div');
                    categoryTitle.style.gridColumn = '1 / -1';
                    categoryTitle.style.fontSize = '1.1rem';
                    categoryTitle.style.fontWeight = '600';
                    categoryTitle.style.color = '#495057';
                    categoryTitle.style.margin = '20px 0 10px 0';
                    categoryTitle.style.paddingBottom = '8px';
                    categoryTitle.style.borderBottom = '2px solid #e9ecef';
                    categoryTitle.textContent = `📊 ${category}`;
                    grid.appendChild(categoryTitle);

                    // 添加该类别的工作流卡片
                    categoryWorkflows.forEach(workflow => {
                        const card = createSimpleWorkflowCard(workflow);
                        grid.appendChild(card);
                    });
                }
            });
        }

        // 创建简化的工作流卡片
        function createSimpleWorkflowCard(workflow) {
            const card = document.createElement('div');
            card.className = 'workflow-card';
            card.style.minHeight = '200px';

            const hasWebhook = workflow.webhookUrl ? '✅' : '❌';
            const status = workflow.status || 'unknown';

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${workflow.id}: ${workflow.name}</div>
                    <div class="card-subtitle">${workflow.description}</div>
                </div>
                <div class="card-body">
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #6c757d;">Webhook配置:</span>
                            <span style="font-weight: 600;">${hasWebhook} ${workflow.webhookUrl ? '已配置' : '未配置'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #6c757d;">最后运行:</span>
                            <span style="font-weight: 600;">${workflow.lastRun || '未运行'}</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #6c757d;">状态:</span>
                            <span style="font-weight: 600;">${getStatusText(status)}</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-success" onclick="triggerWebhook('${workflow.id}')" 
                                ${!workflow.webhookUrl ? 'disabled title="请先配置Webhook URL"' : ''}>
                            ▶️ 运行
                        </button>
                        <a href="https://us2.make.com/972028/scenarios" target="_blank" class="btn btn-primary">
                            🔗 Make控制台
                        </a>
                    </div>
                </div>
            `;

            return card;
        }

        // 获取状态文本
        function getStatusText(status) {
            switch (status) {
                case 'running': return '🔄 运行中';
                case 'completed': return '✅ 已完成';
                case 'failed': return '❌ 失败';
                default: return '❓ 未知';
            }
        }

        // 保存工作流配置
        function saveWorkflows() {
            try {
                localStorage.setItem('workflows', JSON.stringify(workflows));
            } catch (error) {
                console.error('保存配置失败:', error);
                showToast('保存配置失败', 'error');
            }
        }

        // 显示提示消息
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.padding = '15px 20px';
            toast.style.borderRadius = '8px';
            toast.style.color = 'white';
            toast.style.fontWeight = '600';
            toast.style.zIndex = '1000';
            toast.style.transform = 'translateX(400px)';
            toast.style.transition = 'transform 0.3s ease';

            switch (type) {
                case 'success': toast.style.background = '#28a745'; break;
                case 'error': toast.style.background = '#dc3545'; break;
                case 'info': toast.style.background = '#17a2b8'; break;
            }

            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.style.transform = 'translateX(0)', 100);
            setTimeout(() => {
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
