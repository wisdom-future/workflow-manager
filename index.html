<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICTæŠ€æœ¯æƒ…æŠ¥ç³»ç»Ÿ - æ¶æ„åŒ–å·¥ä½œæµç®¡ç†å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-secondary { background: #6c757d; color: white; }

        .architecture-view {
            padding: 30px;
            background: #f8f9fa;
        }

        .layer {
            margin-bottom: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .layer-header {
            padding: 20px 30px;
            font-size: 1.3rem;
            font-weight: 700;
            color: white;
            text-align: center;
            position: relative;
        }

        .layer-1 .layer-header { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
        .layer-2 .layer-header { background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); }
        .layer-3 .layer-header { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); }
        .layer-4 .layer-header { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
        .layer-5 .layer-header { background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%); }

        .layer-content {
            padding: 30px;
        }

        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .workflow-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .workflow-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            border-color: #007bff;
        }

        .card-header {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-bottom: 1px solid #dee2e6;
        }

        .card-title {
            font-size: 1rem;
            font-weight: 700;
            color: #495057;
            margin-bottom: 5px;
        }

        .card-subtitle {
            font-size: 0.8rem;
            color: #6c757d;
            line-height: 1.4;
        }

        .card-body {
            padding: 15px 20px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .status-configured {
            background: #d4edda;
            color: #155724;
        }

        .status-unconfigured {
            background: #f8d7da;
            color: #721c24;
        }

        .status-running {
            background: #fff3cd;
            color: #856404;
        }

        .webhook-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 0.8rem;
            font-family: 'Courier New', monospace;
            margin-bottom: 10px;
        }

        .card-actions {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .card-actions .btn {
            flex: 1;
            font-size: 0.75rem;
            padding: 6px 12px;
            min-width: 60px;
            justify-content: center;
        }

        .dependency-flow {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
            position: relative;
        }

        .flow-arrow {
            font-size: 2rem;
            color: #6c757d;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .layer-stats {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            max-width: 300px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success { background: #28a745; }
        .toast-error { background: #dc3545; }
        .toast-info { background: #17a2b8; }

        .batch-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .batch-controls .btn {
            font-size: 0.8rem;
            padding: 8px 16px;
        }

        @media (max-width: 768px) {
            .workflow-grid {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                padding: 15px;
            }
            
            .card-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡µé¢å¤´éƒ¨ -->
        <div class="header">
            <h1>ğŸ¯ ICTæŠ€æœ¯æƒ…æŠ¥ç³»ç»Ÿæ¶æ„åŒ–å·¥ä½œæµç®¡ç†å™¨</h1>
            <p>åŸºäºåˆ†å±‚æ¶æ„çš„Make.comå·¥ä½œæµç»Ÿä¸€ç®¡ç†å¹³å°</p>
        </div>

        <!-- å…¨å±€æ§åˆ¶åŒº -->
        <div class="controls">
            <button class="btn btn-success" onclick="runLayerSequentially()">
                ğŸš€ æŒ‰å±‚çº§é¡ºåºæ‰§è¡Œ
            </button>
            <button class="btn btn-primary" onclick="runDataCollectionLayer()">
                ğŸ“¥ å¯åŠ¨æ•°æ®é‡‡é›†å±‚
            </button>
            <button class="btn btn-warning" onclick="pauseAllWorkflows()">
                â¸ï¸ æš‚åœæ‰€æœ‰å·¥ä½œæµ
            </button>
            <button class="btn btn-info" onclick="refreshAllStatus()">
                ğŸ”„ åˆ·æ–°æ‰€æœ‰çŠ¶æ€
            </button>
            <button class="btn btn-secondary" onclick="exportAllConfigs()">
                ğŸ“¤ å¯¼å‡ºé…ç½®
            </button>
            <a href="https://us2.make.com/972028/scenarios" target="_blank" class="btn btn-primary">
                ğŸ”— Makeæ§åˆ¶å°
            </a>
        </div>

        <!-- æ¶æ„è§†å›¾ -->
        <div class="architecture-view">
            <!-- ç¬¬ä¸€å±‚ï¼šæ•°æ®é‡‡é›†å±‚ -->
            <div class="layer layer-1">
                <div class="layer-header">
                    ğŸ“¥ ç¬¬ä¸€å±‚ï¼šæ•°æ®é‡‡é›†å±‚ (å¹¶è¡Œæ‰§è¡Œ)
                    <div class="layer-stats" id="layer1-stats">0/6 å·²é…ç½®</div>
                </div>
                <div class="layer-content">
                    <div class="batch-controls">
                        <button class="btn btn-success" onclick="runLayer(1)">â–¶ï¸ å¯åŠ¨æœ¬å±‚</button>
                        <button class="btn btn-warning" onclick="pauseLayer(1)">â¸ï¸ æš‚åœæœ¬å±‚</button>
                        <button class="btn btn-info" onclick="checkLayerStatus(1)">ğŸ“Š æ£€æŸ¥çŠ¶æ€</button>
                    </div>
                    <div class="workflow-grid" id="layer1-grid">
                        <!-- ç¬¬ä¸€å±‚å·¥ä½œæµå°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ä¾èµ–æµå‘ç®­å¤´ -->
            <div class="dependency-flow">
                <div class="flow-arrow">â¬‡ï¸</div>
            </div>

            <!-- ç¬¬äºŒå±‚ï¼šä¿¡å·è¯†åˆ«å±‚ -->
            <div class="layer layer-2">
                <div class="layer-header">
                    ğŸ¯ ç¬¬äºŒå±‚ï¼šä¿¡å·è¯†åˆ«å±‚ (ä¸²è¡Œæ‰§è¡Œ)
                    <div class="layer-stats" id="layer2-stats">0/2 å·²é…ç½®</div>
                </div>
                <div class="layer-content">
                    <div class="batch-controls">
                        <button class="btn btn-success" onclick="runLayer(2)">â–¶ï¸ å¯åŠ¨æœ¬å±‚</button>
                        <button class="btn btn-warning" onclick="pauseLayer(2)">â¸ï¸ æš‚åœæœ¬å±‚</button>
                        <button class="btn btn-info" onclick="checkLayerStatus(2)">ğŸ“Š æ£€æŸ¥çŠ¶æ€</button>
                    </div>
                    <div class="workflow-grid" id="layer2-grid">
                        <!-- ç¬¬äºŒå±‚å·¥ä½œæµå°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ä¾èµ–æµå‘ç®­å¤´ -->
            <div class="dependency-flow">
                <div class="flow-arrow">â¬‡ï¸</div>
            </div>

            <!-- ç¬¬ä¸‰å±‚ï¼šæ·±åº¦åˆ†æå±‚ -->
            <div class="layer layer-3">
                <div class="layer-header">
                    ğŸ“Š ç¬¬ä¸‰å±‚ï¼šæ·±åº¦åˆ†æå±‚ (å¹¶è¡Œæ‰§è¡Œ)
                    <div class="layer-stats" id="layer3-stats">0/3 å·²é…ç½®</div>
                </div>
                <div class="layer-content">
                    <div class="batch-controls">
                        <button class="btn btn-success" onclick="runLayer(3)">â–¶ï¸ å¯åŠ¨æœ¬å±‚</button>
                        <button class="btn btn-warning" onclick="pauseLayer(3)">â¸ï¸ æš‚åœæœ¬å±‚</button>
                        <button class="btn btn-info" onclick="checkLayerStatus(3)">ğŸ“Š æ£€æŸ¥çŠ¶æ€</button>
                    </div>
                    <div class="workflow-grid" id="layer3-grid">
                        <!-- ç¬¬ä¸‰å±‚å·¥ä½œæµå°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ä¾èµ–æµå‘ç®­å¤´ -->
            <div class="dependency-flow">
                <div class="flow-arrow">â¬‡ï¸</div>
            </div>

            <!-- ç¬¬å››å±‚ï¼šå†³ç­–æ”¯æ’‘å±‚ -->
            <div class="layer layer-4">
                <div class="layer-header">
                    ğŸ¯ ç¬¬å››å±‚ï¼šå†³ç­–æ”¯æ’‘å±‚ (ä¸²è¡Œæ‰§è¡Œ)
                    <div class="layer-stats" id="layer4-stats">0/2 å·²é…ç½®</div>
                </div>
                <div class="layer-content">
                    <div class="batch-controls">
                        <button class="btn btn-success" onclick="runLayer(4)">â–¶ï¸ å¯åŠ¨æœ¬å±‚</button>
                        <button class="btn btn-warning" onclick="pauseLayer(4)">â¸ï¸ æš‚åœæœ¬å±‚</button>
                        <button class="btn btn-info" onclick="checkLayerStatus(4)">ğŸ“Š æ£€æŸ¥çŠ¶æ€</button>
                    </div>
                    <div class="workflow-grid" id="layer4-grid">
                        <!-- ç¬¬å››å±‚å·¥ä½œæµå°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- ä¾èµ–æµå‘ç®­å¤´ -->
            <div class="dependency-flow">
                <div class="flow-arrow">â¬‡ï¸</div>
            </div>

            <!-- ç¬¬äº”å±‚ï¼šç³»ç»Ÿç»´æŠ¤å±‚ -->
            <div class="layer layer-5">
                <div class="layer-header">
                    ğŸ”§ ç¬¬äº”å±‚ï¼šç³»ç»Ÿç»´æŠ¤å±‚ (ç‹¬ç«‹è¿è¡Œ)
                    <div class="layer-stats" id="layer5-stats">0/2 å·²é…ç½®</div>
                </div>
                <div class="layer-content">
                    <div class="batch-controls">
                        <button class="btn btn-success" onclick="runLayer(5)">â–¶ï¸ å¯åŠ¨æœ¬å±‚</button>
                        <button class="btn btn-warning" onclick="pauseLayer(5)">â¸ï¸ æš‚åœæœ¬å±‚</button>
                        <button class="btn btn-info" onclick="checkLayerStatus(5)">ğŸ“Š æ£€æŸ¥çŠ¶æ€</button>
                    </div>
                    <div class="workflow-grid" id="layer5-grid">
                        <!-- ç¬¬äº”å±‚å·¥ä½œæµå°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æŒ‰æ¶æ„å›¾å®šä¹‰çš„å·¥ä½œæµé…ç½®
        let workflows = JSON.parse(localStorage.getItem('workflows')) || {
            // ç¬¬ä¸€å±‚ï¼šæ•°æ®é‡‡é›†å±‚ (å¹¶è¡Œæ‰§è¡Œ)
            'WF1': {
                id: 'WF1',
                name: 'å­¦æœ¯è®ºæ–‡æ–‡çŒ®æµ',
                description: 'ç›‘æ§arXivã€Google Scholarã€IEEEç­‰å­¦æœ¯è®ºæ–‡æ•°æ®æº',
                layer: 1,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: []
            },
            'WF2': {
                id: 'WF2',
                name: 'ä¸“åˆ©ç”³è¯·è¿½è¸ªæµ',
                description: 'è¿½è¸ªUSPTOã€EPOã€Google Patentsç­‰ä¸“åˆ©ç”³è¯·',
                layer: 1,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: []
            },
            'WF3': {
                id: 'WF3',
                name: 'å¼€æºé¡¹ç›®ç›‘æµ‹æµ',
                description: 'ç›‘æµ‹GitHubã€GitLabç­‰å¼€æºé¡¹ç›®åŠ¨æ€',
                layer: 1,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: []
            },
            'WF4': {
                id: 'WF4',
                name: 'äº§ä¸šæ–°é—»ç›‘æ§æµ',
                description: 'è·å–TechCrunchã€MIT Tech Reviewç­‰äº§ä¸šæ–°é—»',
                layer: 1,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: []
            },
            'WF5': {
                id: 'WF5',
                name: 'äº§ä¸šåŠ¨æ€æ•è·æµ',
                description: 'æ•è·ä¼šè®®ã€SECæ–‡ä»¶ã€å…¬å¸å…¬å‘Šç­‰äº§ä¸šåŠ¨æ€',
                layer: 1,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: []
            },
            'WF6': {
                id: 'WF6',
                name: 'ç«äº‰å¯¹æ‰‹æ”¶é›†æµ',
                description: 'æ”¶é›†ç«äº‰å¯¹æ‰‹ç›¸å…³æƒ…æŠ¥å’Œå¸‚åœºåŠ¨æ€',
                layer: 1,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: []
            },

            // ç¬¬äºŒå±‚ï¼šä¿¡å·è¯†åˆ«å±‚ (ä¸²è¡Œæ‰§è¡Œ)
            'WF7': {
                id: 'WF7',
                name: 'æŠ€æœ¯ä¿¡å·è¯†åˆ«æµ',
                description: 'ä»åŸå§‹æ•°æ®ä¸­è¯†åˆ«æŠ€æœ¯çªç ´ä¿¡å·å’Œåˆ›æ–°ç‚¹',
                layer: 2,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: ['WF1', 'WF2', 'WF3', 'WF4', 'WF5', 'WF6']
            },
            'WF8': {
                id: 'WF8',
                name: 'è¯æ®éªŒè¯å¤„ç†æµ',
                description: 'éªŒè¯æƒ…æŠ¥è¯æ®çš„è´¨é‡ã€å¯ä¿¡åº¦å’Œä¸€è‡´æ€§',
                layer: 2,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: ['WF7']
            },

            // ç¬¬ä¸‰å±‚ï¼šæ·±åº¦åˆ†æå±‚ (å¹¶è¡Œæ‰§è¡Œ)
            'WF9': {
                id: 'WF9',
                name: 'å•†ä¸šä»·å€¼åˆ†ææµ',
                description: 'åˆ†ææŠ€æœ¯çš„å•†ä¸šä»·å€¼ã€å¸‚åœºæ½œåŠ›å’ŒæŠ•èµ„å›æŠ¥',
                layer: 3,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: ['WF8']
            },
            'WF10': {
                id: 'WF10',
                name: 'ç«äº‰æƒ…æŠ¥åˆ†ææµ',
                description: 'åˆ†æç«äº‰æ€åŠ¿ã€å¨èƒç­‰çº§å’Œå¸‚åœºåœ°ä½',
                layer: 3,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: ['WF8']
            },
            'WF11': {
                id: 'WF11',
                name: 'æŠ€æœ¯æ·±åº¦åˆ†ææµ',
                description: 'æ·±åº¦åˆ†ææŠ€æœ¯å¯è¡Œæ€§ã€æˆç†Ÿåº¦å’Œå®æ–½è·¯å¾„',
                layer: 3,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: ['WF8']
            },

            // ç¬¬å››å±‚ï¼šå†³ç­–æ”¯æ’‘å±‚ (ä¸²è¡Œæ‰§è¡Œ)
            'WF12': {
                id: 'WF12',
                name: 'æƒ…æŠ¥æ•´åˆå†³ç­–æµ',
                description: 'æ•´åˆæ‰€æœ‰åˆ†æç»“æœï¼Œç”Ÿæˆç»¼åˆå†³ç­–å»ºè®®',
                layer: 4,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: ['WF9', 'WF10', 'WF11']
            },
            'WF13': {
                id: 'WF13',
                name: 'æŠ¥å‘Šç”Ÿæˆè¾“å‡ºæµ',
                description: 'ç”Ÿæˆæƒ…æŠ¥æŠ¥å‘Šå¹¶åˆ†å‘åˆ°å„ä¸ªæ¸ é“',
                layer: 4,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: ['WF12']
            },

            // ç¬¬äº”å±‚ï¼šç³»ç»Ÿç»´æŠ¤å±‚ (ç‹¬ç«‹è¿è¡Œ)
            'WF14': {
                id: 'WF14',
                name: 'æ•°æ®è´¨é‡ç›‘æ§æµ',
                description: 'ç›‘æ§æ•°æ®è´¨é‡ã€å®Œæ•´æ€§å’Œä¸€è‡´æ€§',
                layer: 5,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: []
            },
            'WF15': {
                id: 'WF15',
                name: 'ç³»ç»Ÿå¥åº·æ£€æŸ¥æµ',
                description: 'æ£€æŸ¥ç³»ç»Ÿè¿è¡ŒçŠ¶æ€å’Œæ€§èƒ½æŒ‡æ ‡',
                layer: 5,
                webhookUrl: '',
                status: 'unconfigured',
                lastRun: null,
                dependencies: []
            }
        };

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        // åˆå§‹åŒ–é¡µé¢
        function initializePage() {
            renderAllLayers();
            updateAllLayerStats();
        }

        // æ¸²æŸ“æ‰€æœ‰å±‚çº§
        function renderAllLayers() {
            for (let layer = 1; layer <= 5; layer++) {
                renderLayer(layer);
            }
        }

        // æ¸²æŸ“å•ä¸ªå±‚çº§
        function renderLayer(layerNumber) {
            const grid = document.getElementById(`layer${layerNumber}-grid`);
            grid.innerHTML = '';

            const layerWorkflows = Object.values(workflows).filter(wf => wf.layer === layerNumber);

            layerWorkflows.forEach(workflow => {
                const card = createWorkflowCard(workflow);
                grid.appendChild(card);
            });
        }

        // åˆ›å»ºå·¥ä½œæµå¡ç‰‡
        function createWorkflowCard(workflow) {
            const card = document.createElement('div');
            card.className = 'workflow-card';
            card.id = `card-${workflow.id}`;

            const isConfigured = workflow.webhookUrl ? 'configured' : 'unconfigured';
            const statusText = workflow.webhookUrl ? 'âœ… å·²é…ç½®' : 'âŒ æœªé…ç½®';

            card.innerHTML = `
                <div class="card-header">
                    <div class="card-title">${workflow.id}: ${workflow.name}</div>
                    <div class="card-subtitle">${workflow.description}</div>
                </div>
                <div class="card-body">
                    <div class="status-indicator status-${isConfigured}">
                        ${statusText}
                    </div>
                    
                    ${workflow.dependencies.length > 0 ? `
                    <div style="margin-bottom: 10px; font-size: 0.75rem; color: #6c757d;">
                        <strong>ä¾èµ–:</strong> ${workflow.dependencies.join(', ')}
                    </div>
                    ` : ''}
                    
                    <input type="url" class="webhook-input" 
                           placeholder="è¾“å…¥Webhook URL" 
                           value="${workflow.webhookUrl || ''}"
                           onchange="updateWebhookUrl('${workflow.id}', this.value)">
                    
                    <div style="font-size: 0.75rem; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #6c757d;">æœ€åè¿è¡Œ:</span>
                            <span>${workflow.lastRun || 'æœªè¿è¡Œ'}</span>
                        </div>
                    </div>

                    <div class="card-actions">
                        <button class="btn btn-success" onclick="triggerWorkflow('${workflow.id}')" 
                                ${!workflow.webhookUrl ? 'disabled title="è¯·å…ˆé…ç½®Webhook"' : ''}>
                            â–¶ï¸ è¿è¡Œ
                        </button>
                        <button class="btn btn-info" onclick="testWebhook('${workflow.id}')" 
                                ${!workflow.webhookUrl ? 'disabled' : ''}>
                            ğŸ§ª æµ‹è¯•
                        </button>
                        <a href="https://us2.make.com/972028/scenarios" target="_blank" class="btn btn-secondary">
                            ğŸ”— Make
                        </a>
                    </div>
                </div>
            `;

            return card;
        }

        // æ›´æ–°Webhook URL
        function updateWebhookUrl(workflowId, url) {
            workflows[workflowId].webhookUrl = url.trim();
            workflows[workflowId].status = url.trim() ? 'configured' : 'unconfigured';
            saveWorkflows();
            
            // é‡æ–°æ¸²æŸ“å¯¹åº”å±‚çº§
            const workflow = workflows[workflowId];
            renderLayer(workflow.layer);
            updateLayerStats(workflow.layer);
            
            showToast(`${workflowId} Webhook URLå·²æ›´æ–°`, 'info');
        }

        // è§¦å‘å•ä¸ªå·¥ä½œæµ
        async function triggerWorkflow(workflowId) {
            const workflow = workflows[workflowId];
            if (!workflow.webhookUrl) {
                showToast('è¯·å…ˆé…ç½®Webhook URL', 'error');
                return;
            }

            // æ£€æŸ¥ä¾èµ–å…³ç³»
            if (workflow.dependencies.length > 0) {
                const unmetDependencies = workflow.dependencies.filter(depId => {
                    const dep = workflows[depId];
                    return !dep || dep.status !== 'completed';
                });

                if (unmetDependencies.length > 0) {
                    const proceed = confirm(`ä¾èµ–é¡¹ ${unmetDependencies.join(', ')} å¯èƒ½æœªå®Œæˆã€‚ç¡®å®šè¦ç»§ç»­è¿è¡Œå—ï¼Ÿ`);
                    if (!proceed) return;
                }
            }

            showToast(`æ­£åœ¨è§¦å‘ ${workflowId}...`, 'info');

            try {
                const response = await fetch(workflow.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        trigger_source: 'architecture_manager',
                        workflow_id: workflowId,
                        layer: workflow.layer,
                        dependencies: workflow.dependencies,
                        timestamp: new Date().toISOString(),
                        user: 'Jason'
                    })
                });

                if (response.ok) {
                    showToast(`${workflowId} è§¦å‘æˆåŠŸï¼`, 'success');
                    workflow.lastRun = new Date().toLocaleString();
                    workflow.status = 'running';
                    saveWorkflows();
                    renderLayer(workflow.layer);
                } else {
                    throw new Error(`HTTP ${response.status}`);
                }
            } catch (error) {
                showToast(`${workflowId} è§¦å‘å¤±è´¥: ${error.message}`, 'error');
                console.error('Webhookè§¦å‘å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•Webhook
        async function testWebhook(workflowId) {
            const workflow = workflows[workflowId];
            if (!workflow.webhookUrl) {
                showToast('è¯·å…ˆé…ç½®Webhook URL', 'error');
                return;
            }

            try {
                const response = await fetch(workflow.webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        test: true,
                        workflow_id: workflowId,
                        timestamp: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    showToast(`${workflowId} Webhookæµ‹è¯•æˆåŠŸ`, 'success');
                } else {
                    showToast(`${workflowId} Webhookæµ‹è¯•å¤±è´¥: ${response.status}`, 'error');
                }
            } catch (error) {
                showToast(`${workflowId} Webhookæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // è¿è¡Œæ•´ä¸ªå±‚çº§
        async function runLayer(layerNumber) {
            const layerWorkflows = Object.values(workflows).filter(wf => 
                wf.layer === layerNumber && wf.webhookUrl
            );

            if (layerWorkflows.length === 0) {
                showToast(`ç¬¬${layerNumber}å±‚æ²¡æœ‰é…ç½®çš„å·¥ä½œæµ`, 'error');
                return;
            }

            if (!confirm(`ç¡®å®šè¦è¿è¡Œç¬¬${layerNumber}å±‚çš„æ‰€æœ‰å·¥ä½œæµå—ï¼Ÿ`)) return;

            showToast(`æ­£åœ¨è¿è¡Œç¬¬${layerNumber}å±‚ ${layerWorkflows.length} ä¸ªå·¥ä½œæµ...`, 'info');

            // æ ¹æ®å±‚çº§ç‰¹æ€§å†³å®šæ‰§è¡Œæ–¹å¼
            if (layerNumber === 1 || layerNumber === 3) {
                // å¹¶è¡Œæ‰§è¡Œ
                const promises = layerWorkflows.map(wf => triggerWorkflow(wf.id));
                await Promise.all(promises);
            } else {
                // ä¸²è¡Œæ‰§è¡Œ
                for (const workflow of layerWorkflows) {
                    await triggerWorkflow(workflow.id);
                    await new Promise(resolve => setTimeout(resolve, 2000));
                                    }
            }

            showToast(`ç¬¬${layerNumber}å±‚æ‰§è¡Œå®Œæˆ`, 'success');
        }

        // æš‚åœæ•´ä¸ªå±‚çº§
        async function pauseLayer(layerNumber) {
            const layerWorkflows = Object.values(workflows).filter(wf => wf.layer === layerNumber);
            
            if (!confirm(`ç¡®å®šè¦æš‚åœç¬¬${layerNumber}å±‚çš„æ‰€æœ‰å·¥ä½œæµå—ï¼Ÿ`)) return;

            layerWorkflows.forEach(workflow => {
                workflow.status = 'paused';
            });

            saveWorkflows();
            renderLayer(layerNumber);
            showToast(`ç¬¬${layerNumber}å±‚å·²æš‚åœ`, 'info');
        }

        // æ£€æŸ¥å±‚çº§çŠ¶æ€
        function checkLayerStatus(layerNumber) {
            const layerWorkflows = Object.values(workflows).filter(wf => wf.layer === layerNumber);
            const configuredCount = layerWorkflows.filter(wf => wf.webhookUrl).length;
            const runningCount = layerWorkflows.filter(wf => wf.status === 'running').length;
            const completedCount = layerWorkflows.filter(wf => wf.status === 'completed').length;

            const statusMessage = `ç¬¬${layerNumber}å±‚çŠ¶æ€:\n` +
                `æ€»å·¥ä½œæµ: ${layerWorkflows.length}\n` +
                `å·²é…ç½®: ${configuredCount}\n` +
                `è¿è¡Œä¸­: ${runningCount}\n` +
                `å·²å®Œæˆ: ${completedCount}`;

            alert(statusMessage);
        }

        // æŒ‰å±‚çº§é¡ºåºæ‰§è¡Œ
        async function runLayerSequentially() {
            if (!confirm('ç¡®å®šè¦æŒ‰ç…§æ¶æ„å±‚çº§é¡ºåºæ‰§è¡Œæ‰€æœ‰å·¥ä½œæµå—ï¼Ÿè¿™å°†æŒ‰ç…§ä¾èµ–å…³ç³»ä¾æ¬¡æ‰§è¡Œå„å±‚çº§ã€‚')) return;

            showToast('å¼€å§‹æŒ‰å±‚çº§é¡ºåºæ‰§è¡Œ...', 'info');

            try {
                // ç¬¬ä¸€å±‚ï¼šæ•°æ®é‡‡é›†å±‚ (å¹¶è¡Œ)
                showToast('æ‰§è¡Œç¬¬1å±‚ï¼šæ•°æ®é‡‡é›†å±‚...', 'info');
                await runLayer(1);
                await waitForLayerCompletion(1, 300000); // ç­‰å¾…5åˆ†é’Ÿ

                // ç¬¬äºŒå±‚ï¼šä¿¡å·è¯†åˆ«å±‚ (ä¸²è¡Œ)
                showToast('æ‰§è¡Œç¬¬2å±‚ï¼šä¿¡å·è¯†åˆ«å±‚...', 'info');
                await runLayer(2);
                await waitForLayerCompletion(2, 600000); // ç­‰å¾…10åˆ†é’Ÿ

                // ç¬¬ä¸‰å±‚ï¼šæ·±åº¦åˆ†æå±‚ (å¹¶è¡Œ)
                showToast('æ‰§è¡Œç¬¬3å±‚ï¼šæ·±åº¦åˆ†æå±‚...', 'info');
                await runLayer(3);
                await waitForLayerCompletion(3, 480000); // ç­‰å¾…8åˆ†é’Ÿ

                // ç¬¬å››å±‚ï¼šå†³ç­–æ”¯æ’‘å±‚ (ä¸²è¡Œ)
                showToast('æ‰§è¡Œç¬¬4å±‚ï¼šå†³ç­–æ”¯æ’‘å±‚...', 'info');
                await runLayer(4);
                await waitForLayerCompletion(4, 240000); // ç­‰å¾…4åˆ†é’Ÿ

                showToast('âœ… æ‰€æœ‰å±‚çº§æ‰§è¡Œå®Œæˆï¼', 'success');
            } catch (error) {
                showToast(`æ‰§è¡Œè¿‡ç¨‹ä¸­å‡ºé”™: ${error.message}`, 'error');
            }
        }

        // ç­‰å¾…å±‚çº§å®Œæˆ
        function waitForLayerCompletion(layerNumber, maxWaitTime) {
            return new Promise((resolve) => {
                showToast(`ç­‰å¾…ç¬¬${layerNumber}å±‚å®Œæˆ...`, 'info');
                setTimeout(() => {
                    // æ ‡è®°è¯¥å±‚çº§ä¸ºå®ŒæˆçŠ¶æ€
                    const layerWorkflows = Object.values(workflows).filter(wf => wf.layer === layerNumber);
                    layerWorkflows.forEach(wf => {
                        if (wf.status === 'running') {
                            wf.status = 'completed';
                        }
                    });
                    saveWorkflows();
                    renderLayer(layerNumber);
                    resolve();
                }, maxWaitTime);
            });
        }

        // å¯åŠ¨æ•°æ®é‡‡é›†å±‚
        async function runDataCollectionLayer() {
            await runLayer(1);
        }

        // æš‚åœæ‰€æœ‰å·¥ä½œæµ
        function pauseAllWorkflows() {
            if (!confirm('ç¡®å®šè¦æš‚åœæ‰€æœ‰å·¥ä½œæµå—ï¼Ÿ')) return;

            Object.values(workflows).forEach(workflow => {
                workflow.status = 'paused';
            });

            saveWorkflows();
            renderAllLayers();
            updateAllLayerStats();
            showToast('æ‰€æœ‰å·¥ä½œæµå·²æš‚åœ', 'info');
        }

        // åˆ·æ–°æ‰€æœ‰çŠ¶æ€
        function refreshAllStatus() {
            showToast('æ­£åœ¨åˆ·æ–°æ‰€æœ‰çŠ¶æ€...', 'info');
            
            // æ¨¡æ‹ŸçŠ¶æ€åˆ·æ–°
            Object.values(workflows).forEach(workflow => {
                if (workflow.webhookUrl && workflow.status === 'running') {
                    // éšæœºè®¾ç½®ä¸€äº›å·¥ä½œæµä¸ºå®ŒæˆçŠ¶æ€
                    if (Math.random() > 0.7) {
                        workflow.status = 'completed';
                    }
                }
            });

            saveWorkflows();
            renderAllLayers();
            updateAllLayerStats();
            showToast('çŠ¶æ€åˆ·æ–°å®Œæˆ', 'success');
        }

        // å¯¼å‡ºæ‰€æœ‰é…ç½®
        function exportAllConfigs() {
            const exportData = {
                workflows: workflows,
                architecture: {
                    layers: [
                        { number: 1, name: 'æ•°æ®é‡‡é›†å±‚', execution: 'parallel', workflows: ['WF1', 'WF2', 'WF3', 'WF4', 'WF5', 'WF6'] },
                        { number: 2, name: 'ä¿¡å·è¯†åˆ«å±‚', execution: 'serial', workflows: ['WF7', 'WF8'] },
                        { number: 3, name: 'æ·±åº¦åˆ†æå±‚', execution: 'parallel', workflows: ['WF9', 'WF10', 'WF11'] },
                        { number: 4, name: 'å†³ç­–æ”¯æ’‘å±‚', execution: 'serial', workflows: ['WF12', 'WF13'] },
                        { number: 5, name: 'ç³»ç»Ÿç»´æŠ¤å±‚', execution: 'independent', workflows: ['WF14', 'WF15'] }
                    ]
                },
                exportTime: new Date().toISOString(),
                version: '2.0.0'
            };

            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `ict-architecture-config-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('æ¶æ„é…ç½®å·²å¯¼å‡º', 'success');
        }

        // æ›´æ–°æ‰€æœ‰å±‚çº§ç»Ÿè®¡
        function updateAllLayerStats() {
            for (let layer = 1; layer <= 5; layer++) {
                updateLayerStats(layer);
            }
        }

        // æ›´æ–°å•ä¸ªå±‚çº§ç»Ÿè®¡
        function updateLayerStats(layerNumber) {
            const layerWorkflows = Object.values(workflows).filter(wf => wf.layer === layerNumber);
            const configuredCount = layerWorkflows.filter(wf => wf.webhookUrl).length;
            const totalCount = layerWorkflows.length;

            const statsElement = document.getElementById(`layer${layerNumber}-stats`);
            if (statsElement) {
                statsElement.textContent = `${configuredCount}/${totalCount} å·²é…ç½®`;
            }
        }

        // ä¿å­˜å·¥ä½œæµé…ç½®
        function saveWorkflows() {
            try {
                localStorage.setItem('workflows', JSON.stringify(workflows));
            } catch (error) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', error);
                showToast('ä¿å­˜é…ç½®å¤±è´¥', 'error');
            }
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // æ·»åŠ æ‰¹é‡é…ç½®åŠŸèƒ½
        function batchConfigureWebhooks() {
            const baseUrl = prompt('è¯·è¾“å…¥WebhookåŸºç¡€URL (ä¾‹å¦‚: https://hook.make.com/abc123):');
            if (!baseUrl) return;

            Object.values(workflows).forEach((workflow, index) => {
                if (!workflow.webhookUrl) {
                    workflow.webhookUrl = `${baseUrl}/${workflow.id.toLowerCase()}`;
                    workflow.status = 'configured';
                }
            });

            saveWorkflows();
            renderAllLayers();
            updateAllLayerStats();
            showToast('æ‰¹é‡é…ç½®å®Œæˆ', 'success');
        }

        // æ·»åŠ ä¾èµ–å…³ç³»æ£€æŸ¥
        function checkDependencies(workflowId) {
            const workflow = workflows[workflowId];
            const unmetDependencies = [];

            workflow.dependencies.forEach(depId => {
                const dep = workflows[depId];
                if (!dep || dep.status !== 'completed') {
                    unmetDependencies.push(depId);
                }
            });

            return unmetDependencies;
        }

        // æ·»åŠ æ¶æ„éªŒè¯
        function validateArchitecture() {
            const issues = [];

            // æ£€æŸ¥ä¾èµ–å…³ç³»æ˜¯å¦æ­£ç¡®
            Object.values(workflows).forEach(workflow => {
                workflow.dependencies.forEach(depId => {
                    const dep = workflows[depId];
                    if (!dep) {
                        issues.push(`${workflow.id} ä¾èµ–çš„ ${depId} ä¸å­˜åœ¨`);
                    } else if (dep.layer >= workflow.layer) {
                        issues.push(`${workflow.id} ä¸èƒ½ä¾èµ–åŒå±‚æˆ–ä¸‹å±‚çš„ ${depId}`);
                    }
                });
            });

            if (issues.length > 0) {
                alert('æ¶æ„éªŒè¯å‘ç°é—®é¢˜:\n' + issues.join('\n'));
            } else {
                showToast('æ¶æ„éªŒè¯é€šè¿‡', 'success');
            }
        }

        // æ·»åŠ é”®ç›˜å¿«æ·é”®æ”¯æŒ
        document.addEventListener('keydown', function(e) {
            // Ctrl+1-5 å¿«é€Ÿè¿è¡Œå¯¹åº”å±‚çº§
            if (e.ctrlKey && e.key >= '1' && e.key <= '5') {
                e.preventDefault();
                const layer = parseInt(e.key);
                runLayer(layer);
            }
            
            // Ctrl+A è¿è¡Œæ‰€æœ‰å±‚çº§
            if (e.ctrlKey && e.key === 'a') {
                e.preventDefault();
                runLayerSequentially();
            }
            
            // Ctrl+S ä¿å­˜é…ç½®
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveWorkflows();
                showToast('é…ç½®å·²ä¿å­˜', 'success');
            }
            
            // Ctrl+E å¯¼å‡ºé…ç½®
            if (e.ctrlKey && e.key === 'e') {
                e.preventDefault();
                exportAllConfigs();
            }
        });

        // æ·»åŠ å³é”®èœå•åŠŸèƒ½
        document.addEventListener('contextmenu', function(e) {
            const card = e.target.closest('.workflow-card');
            if (card) {
                e.preventDefault();
                const workflowId = card.id.replace('card-', '');
                showWorkflowContextMenu(e.pageX, e.pageY, workflowId);
            }
        });

        function showWorkflowContextMenu(x, y, workflowId) {
            const menu = document.createElement('div');
            menu.style.position = 'absolute';
            menu.style.left = x + 'px';
            menu.style.top = y + 'px';
            menu.style.background = 'white';
            menu.style.border = '1px solid #ccc';
            menu.style.borderRadius = '4px';
            menu.style.boxShadow = '0 2px 10px rgba(0,0,0,0.1)';
            menu.style.zIndex = '1000';
            menu.style.padding = '5px 0';

            const actions = [
                { text: 'è¿è¡Œå·¥ä½œæµ', action: () => triggerWorkflow(workflowId) },
                { text: 'æµ‹è¯•Webhook', action: () => testWebhook(workflowId) },
                { text: 'æ£€æŸ¥ä¾èµ–', action: () => {
                    const deps = checkDependencies(workflowId);
                    alert(deps.length ? `æœªæ»¡è¶³ä¾èµ–: ${deps.join(', ')}` : 'æ‰€æœ‰ä¾èµ–å·²æ»¡è¶³');
                }},
                { text: 'å¤åˆ¶é…ç½®', action: () => {
                    navigator.clipboard.writeText(JSON.stringify(workflows[workflowId], null, 2));
                    showToast('é…ç½®å·²å¤åˆ¶', 'info');
                }}
            ];

            actions.forEach(action => {
                const item = document.createElement('div');
                item.style.padding = '8px 16px';
                item.style.cursor = 'pointer';
                item.textContent = action.text;
                item.onmouseover = () => item.style.background = '#f0f0f0';
                item.onmouseout = () => item.style.background = 'transparent';
                item.onclick = () => {
                    action.action();
                    document.body.removeChild(menu);
                };
                menu.appendChild(item);
            });

            document.body.appendChild(menu);

            // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
            setTimeout(() => {
                document.addEventListener('click', function closeMenu() {
                    if (document.body.contains(menu)) {
                        document.body.removeChild(menu);
                    }
                    document.removeEventListener('click', closeMenu);
                }, 100);
            });
        }

        // å®šæ—¶è‡ªåŠ¨ä¿å­˜
        setInterval(saveWorkflows, 30000); // æ¯30ç§’è‡ªåŠ¨ä¿å­˜

        // é¡µé¢å¸è½½å‰ä¿å­˜
        window.addEventListener('beforeunload', function() {
            saveWorkflows();
        });

        // æ·»åŠ æ‹–æ‹½æ’åºåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
        function enableDragAndDrop() {
            const cards = document.querySelectorAll('.workflow-card');
            cards.forEach(card => {
                card.draggable = true;
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('drop', handleDrop);
            });
        }

        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.id);
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDrop(e) {
            e.preventDefault();
            const draggedId = e.dataTransfer.getData('text/plain');
            const targetId = e.target.closest('.workflow-card').id;
            
            if (draggedId !== targetId) {
                // è¿™é‡Œå¯ä»¥å®ç°å·¥ä½œæµé‡æ–°æ’åºé€»è¾‘
                showToast('æ‹–æ‹½æ’åºåŠŸèƒ½å¼€å‘ä¸­', 'info');
            }
        }

        // åˆå§‹åŒ–å®Œæˆåå¯ç”¨é«˜çº§åŠŸèƒ½
        setTimeout(() => {
            enableDragAndDrop();
            validateArchitecture();
        }, 1000);
    </script>
</body>
</html>
